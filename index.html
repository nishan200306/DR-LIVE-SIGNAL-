<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Predictor App</title>

  <!-- Parse SDK -->
  <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
  <!-- Title font for splash -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

  <style>
    /* BASE STYLES & ANIMATIONS (Same as before) */
    @property --angle { syntax:'<angle>'; initial-value:0deg; inherits:false; }
    @keyframes rgb-lights { from{--angle:0deg} to{--angle:360deg} }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    @keyframes floaty { 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }
    @keyframes pulse { 0%, 100% { background-color: #00ff99; box-shadow: 0 0 8px #00ff99; } 50% { background-color: #00804d; box-shadow: none; } }

    :root{
      --gold:#FFD700;
      --blue1:#2aa4ff;
      --blue2:#1e90ff;
      --green:#00ff99;
    }

    #bgCanvas{ position:fixed; inset:0; z-index:0; pointer-events:none; background: radial-gradient(1200px 800px at 100% -10%, rgba(255,56,56,.10), transparent 60%), radial-gradient(900px 600px at -20% 110%, rgba(255,56,56,.08), transparent 60%), #000000; }
    body{font-family:'Segoe UI',Arial,sans-serif; background:#000; color:#fff; margin:0; padding:20px; text-align:center; overflow:hidden}
    .page{position:relative; z-index:1; display:none; flex-direction:column; align-items:center; justify-content:center; min-height:calc(100vh - 40px); animation:fadeIn .35s ease}
    .page.active{display:flex}
    h1,h2{color:var(--gold); text-shadow:0 0 10px var(--gold); margin-bottom:36px}
    .button-container{display:flex; flex-direction:column; gap:18px; width:80%; max-width:400px}

    /* BUTTONS (Same as before, with disabled state) */
    .nav-button,.back-button,.submit-button{ position:relative; overflow:hidden; padding:18px; font-size:1.05em; font-weight:800; color:#fff; border-radius:12px; cursor:pointer; border:1px solid rgba(42,164,255,.45); background:linear-gradient(90deg,var(--blue1),var(--blue2),var(--blue1)); background-size:200% 100%; animation:blueSlide 6s linear infinite, blueGlow 2s ease-in-out infinite; box-shadow:0 8px 22px rgba(42,164,255,.25), inset 0 1px 0 rgba(255,255,255,.12); transition:transform .12s ease; }
    .nav-button:active,.back-button:active,.submit-button:active{ transform:translateY(1px) }
    .nav-button:disabled { cursor: not-allowed; background: #555; color: #999; animation: none; box-shadow: none; border-color: #444; }
    .nav-button:disabled::before { display: none; }
    .nav-button::before,.back-button::before,.submit-button::before{ content:""; position:absolute; inset:0; background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.25) 40%, transparent 70%); transform:translateX(-120%); animation:shineRun 2.8s ease-in-out infinite; pointer-events:none; }
    @keyframes blueSlide{0%{background-position:0 0}100%{background-position:-200% 0}}
    @keyframes blueGlow{ 0%,100%{box-shadow:0 0 0 0 rgba(42,164,255,.22),0 8px 22px rgba(42,164,255,.28)} 50%{box-shadow:0 0 0 6px rgba(42,164,255,.12),0 10px 26px rgba(42,164,255,.45)} }
    @keyframes shineRun{0%{transform:translateX(-120%)}60%{transform:translateX(120%)}100%{transform:translateX(120%)}}
    .back-button{position:absolute; top:20px; left:20px; padding:10px 16px; font-size:.95em}

    /* PREDICTION CIRCLE (Same as before) */
    .circle-wrapper{position:relative; width:280px; height:280px; display:flex; align-items:center; justify-content:center}
    .circle{ position:relative; width:100%; height:100%; border-radius:50%; animation:spin 10s linear infinite, rgb-lights 2s linear infinite; border:5px solid transparent; background-image:linear-gradient(black,black), conic-gradient(from var(--angle), red,yellow,lime,aqua,blue,magenta,red); background-origin:border-box; background-clip:content-box, border-box; box-shadow:0 0 15px 5px rgba(255,255,255,.1), 0 0 30px 15px rgba(255,0,255,.2), inset 0 0 15px 5px rgba(0,255,255,.2) }
    .circle-inner-content{position:absolute; display:flex; flex-direction:column; align-items:center; justify-content:center}
    .prediction-time{font-size:2.4em; color:#FF4136; text-shadow:0 0 8px #FF4136}
    .prediction-odd{font-size:2em; color:#00FF00; text-shadow:0 0 8px #00FF00; margin-top:10px}
    .loader{display:none; margin-top:10px; color:#cbd5e1; font-size:.9em}
    .loader.show{display:block}
    
    /* SPLASH SCREEN (Same as before) */
    .splash{ position:fixed; inset:0; z-index:999; display:grid; place-items:center; background: radial-gradient(1200px 800px at 50% -10%, rgba(0,255,153,.10), transparent 60%), linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.95)); transition:opacity .5s ease, visibility .5s ease; }
    .splash.hide{opacity:0; visibility:hidden}
    .splash-inner{display:flex; flex-direction:column; align-items:center; gap:14px; text-align:center}
    .splash-title{ font-family:'Bebas Neue', system-ui, sans-serif; letter-spacing:4px; font-size:56px; color:#d7ffe9; text-shadow:0 0 18px rgba(0,255,153,.35); animation:floaty 2.4s ease-in-out infinite; }
    .progress-wrap{width:min(520px, 86vw); display:flex; flex-direction:column; gap:8px}
    .progress-bar{ position:relative; height:10px; border-radius:999px; overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border:1px solid rgba(255,255,255,.12); box-shadow:inset 0 1px 0 rgba(255,255,255,.06); }
    .progress-fill{ position:absolute; left:0; top:0; height:100%; width:0%; background:linear-gradient(90deg, rgba(0,255,153,.8), rgba(0,255,200,.9), rgba(0,255,153,.8)); box-shadow:0 0 12px rgba(0,255,153,.45); }
    .progress-label{font-weight:900; color:#a4d9c9; letter-spacing:.4px}

    /* PIN PAD (Same as before) */
    .pin-pad-overlay { position: fixed; inset: 0; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: fadeIn 0.3s ease; }
    .pin-pad-overlay.show { display: flex; }
    .pin-pad-content { display: flex; flex-direction: column; align-items: center; gap: 20px; }
    #pin-pad-title { font-size: 1.5em; font-weight: bold; color: var(--gold); text-shadow: 0 0 8px var(--gold); }
    #pin-pad-display { display: flex; gap: 15px; height: 40px; }
    .pin-digit { width: 25px; height: 25px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); transition: all 0.2s ease; }
    .pin-digit.filled { background: var(--green); border-color: var(--green); box-shadow: 0 0 10px var(--green); transform: scale(1.1); }
    #pin-pad-message { height: 40px; font-size: 1.1em; font-weight: bold; color: #ff6b6b; display: flex; align-items: center; justify-content: center; text-align: center; }
    .pin-pad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 300px; width: 80vw; }
    .pin-pad-key { display: grid; place-items: center; font-size: 2em; font-weight: 500; height: 70px; border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; cursor: pointer; background: rgba(255,255,255,0.05); transition: background 0.2s ease; user-select: none; }
    .pin-pad-key:active { background: rgba(255,255,255,0.2); }
    .key-backspace { font-size: 1.5em; }
    .key-close { position: absolute; top: 25px; right: 25px; font-size: 2em; color: rgba(255,255,255,0.6); cursor: pointer; }
    .key-close:hover { color: white; }
    
    /* COUNTER & BLOCK OVERLAY (Same as before) */
    .online-counter { position: absolute; top: 25px; right: 25px; display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
    .online-indicator-bulb { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
    .online-count-text { font-size: 0.9em; font-weight: bold; color: #fff; }
    .app-block-overlay { position: fixed; inset: 0; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; background: black; text-align: center; padding: 20px; }
    .app-block-overlay.show { display: flex; }
    .app-block-title { font-size: 2em; color: #ff4d4d; margin-bottom: 15px; }
    .app-block-message { font-size: 1.2em; color: #ccc; margin-bottom: 30px; }
    .app-block-timer { font-size: 3em; font-weight: bold; color: var(--gold); letter-spacing: 2px; }

    /* --- NEW REGISTRATION FEATURE STYLES --- */
    .profile-container { position: absolute; top: 20px; left: 20px; z-index: 10; }
    #profile-icon, #status-approved-icon { width: 42px; height: 42px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: grid; place-items: center; cursor: pointer; transition: all .3s ease; }
    #profile-icon:hover { background: rgba(255,255,255,0.2); }
    #profile-icon svg { width: 24px; height: 24px; fill: #fff; }
    #status-approved-icon { display: none; background: rgba(0, 255, 153, 0.2); border-color: var(--green); cursor: default; }
    #status-approved-icon svg { width: 24px; height: 24px; fill: var(--green); }
    
    .registration-overlay { position: fixed; inset: 0; z-index: 1100; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: fadeIn 0.3s ease; }
    .registration-overlay.show { display: flex; }
    .registration-content { display: flex; flex-direction: column; align-items: stretch; gap: 20px; background: rgba(20,20,20,0.5); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px; }
    .registration-title { font-size: 1.5em; font-weight: bold; color: var(--gold); text-align: center; margin-bottom: 10px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { text-align: left; font-weight: bold; color: #ccc; }
    .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; font-size: 1em; box-sizing: border-box; }
    #registration-message { min-height: 20px; font-weight: bold; text-align: center; }
    #registration-message.success { color: var(--green); }
    #registration-message.error { color: #ff6b6b; }
    .submit-button { width: 100%; margin-top: 10px; }

  </style>
</head>
<body>
  <!-- Animated background -->
  <canvas id="bgCanvas"></canvas>

  <!-- SPLASH SCREEN -->
  <div id="splash" class="splash">
    <div class="splash-inner">
      <div class="splash-title">DR LIVE SIGNAL</div>
      <div class="progress-wrap"><div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div><div class="progress-label"><span id="progressNum">1</span>%</div></div>
    </div>
  </div>
  
  <!-- APP BLOCK OVERLAY -->
  <div id="app-block-overlay" class="app-block-overlay">
    <div class="app-block-title">APPLICATION BLOCKED</div>
    <div class="app-block-message">Too many incorrect attempts. Please try again after:</div>
    <div id="app-block-timer" class="app-block-timer">--:--:--</div>
  </div>

  <!-- NEW REGISTRATION MODAL -->
  <div id="registration-overlay" class="registration-overlay">
    <div class="key-close" id="registration-close">&times;</div>
    <div class="registration-content">
      <div class="registration-title">Register Your Device</div>
      <div id="registration-message"></div>
      <div class="form-group">
        <label for="reg-user-id">User ID</label>
        <input type="text" id="reg-user-id" placeholder="Enter your user ID">
      </div>
      <div class="form-group">
        <label for="reg-password">Password</label>
        <input type="password" id="reg-password" placeholder="Enter your password">
      </div>
      <div class="form-group">
        <label for="reg-surname">Surname</label>
        <input type="text" id="reg-surname" placeholder="Enter your surname">
      </div>
      <button id="registration-submit" class="submit-button">System Connected</button>
    </div>
  </div>

  <!-- HOME PAGE with Profile Icon and Online Counter -->
  <div id="home-page" class="page">
    <div class="profile-container">
      <div id="profile-icon" title="Register Device">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      </div>
      <div id="status-approved-icon" title="Device Approved">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
      </div>
    </div>
    <div class="online-counter">
        <div class="online-indicator-bulb"></div>
        <span id="online-count" class="online-count-text">...</span>
    </div>
    <h1>PREDICTOR</h1>
    <div class="button-container">
      <button class="nav-button" data-target="xbet-page" data-service="1XBET" disabled>1XBET</button>
      <button class="nav-button" data-target="melbet-page" data-service="MELBET" disabled>MELBET</button>
      <button class="nav-button" data-target="strz-page" data-service="888STRZ" disabled>888STRZ</button>
    </div>
  </div>

  <!-- SERVICE PAGES (Unchanged) -->
  <div id="xbet-page" class="page"> <button class="back-button">Back</button> <h2>1XBET PREDICTOR</h2> <div class="circle-wrapper"> <div class="circle"></div> <div class="circle-inner-content"> <span class="prediction-time" id="time-xbet-page">--:--:--</span> <span class="prediction-odd" id="odd-xbet-page">--.--x</span> <div class="loader" id="load-xbet-page">Loading…</div> </div> </div> </div>
  <div id="melbet-page" class="page"> <button class="back-button">Back</button> <h2>MELBET PREDICTOR</h2> <div class="circle-wrapper"> <div class="circle"></div> <div class="circle-inner-content"> <span class="prediction-time" id="time-melbet-page">--:--:--</span> <span class="prediction-odd" id="odd-melbet-page">--.--x</span> <div class="loader" id="load-melbet-page">Loading…</div> </div> </div> </div>
  <div id="strz-page" class="page"> <button class="back-button">Back</button> <h2>888STRZ PREDICTOR</h2> <div class="circle-wrapper"> <div class="circle"></div> <div class="circle-inner-content"> <span class="prediction-time" id="time-strz-page">--:--:--</span> <span class="prediction-odd" id="odd-strz-page">--.--x</span> <div class="loader" id="load-strz-page">Loading…</div> </div> </div> </div>

  <!-- PIN PAD (Unchanged) -->
  <div id="pin-pad-overlay" class="pin-pad-overlay"> <div class="key-close" id="pin-pad-close">&times;</div> <div class="pin-pad-content"> <div id="pin-pad-title">Enter PIN</div> <div id="pin-pad-display"> <div class="pin-digit"></div> <div class="pin-digit"></div> <div class="pin-digit"></div> <div class="pin-digit"></div> </div> <div id="pin-pad-message"></div> <div class="pin-pad-grid" id="pin-pad-grid"> <div class="pin-pad-key" data-key="1">1</div> <div class="pin-pad-key" data-key="2">2</div> <div class="pin-pad-key" data-key="3">3</div> <div class="pin-pad-key" data-key="4">4</div> <div class="pin-pad-key" data-key="5">5</div> <div class="pin-pad-key" data-key="6">6</div> <div class="pin-pad-key" data-key="7">7</div> <div class="pin-pad-key" data-key="8">8</div> <div class="pin-pad-key" data-key="9">9</div> <div class="pin-pad-key" data-key="clear">C</div> <div class="pin-pad-key" data-key="0">0</div> <div class="pin-pad-key key-backspace" data-key="backspace">⌫</div> </div> </div> </div>

  <script>
    /* === Parse init === */
    Parse.initialize("yJIyt85Wo4x3uQpZrGyuSSuw1i2a3DaXAHEre4Hm","HVVxjkWNYnylI7SYmht6DHH2sTrhheJbHs79qEQj");
    Parse.serverURL = "https://parseapi.back4app.com/";

    /* === Background Canvas JS (Unchanged) === */
    (function(){
      const c = document.getElementById('bgCanvas'); if (!c) return; const ctx = c.getContext('2d'); let W=0, H=0, DPR=1; const ODD_COUNT = 22; let odds = []; let plane = null; function resize(){ DPR = Math.min(2, window.devicePixelRatio||1); W = window.innerWidth; H = window.innerHeight; c.width = W*DPR; c.height = H*DPR; c.style.width = W+'px'; c.style.height = H+'px'; ctx.setTransform(DPR,0,0,DPR,0,0); spawnAll(); } function randOdd(){ const v = 1.10 + Math.random()*(6.5-1.1); return (Math.round(v*100)/100).toFixed(2)+'x'; } function spawnOdd(fromRight=true){ const yPad=40; return { text:randOdd(), x:fromRight?(W+Math.random()*200):(-100-Math.random()*200), y:yPad+Math.random()*(H-yPad*2), speed:0.6+Math.random()*1.4, amp:10+Math.random()*26, phase:Math.random()*Math.PI*2, dir:-1, size:14+Math.random()*6 }; } function spawnAll(){ odds = []; for(let i=0;i<ODD_COUNT;i++){ const o=spawnOdd(true); o.x=Math.random()*W; odds.push(o); } plane={x:-60, y:H*0.28, baseY:H*0.28, speed:1.2, amp:36, freq:0.0025}; } function drawChip(o, time){ const y=o.y+Math.sin((time*0.002+o.phase))*o.amp; o.x+=o.dir*o.speed; ctx.save(); ctx.font=`bold ${o.size}px Segoe UI,Arial`; ctx.shadowColor='rgba(255,80,80,.65)'; ctx.shadowBlur=12; ctx.fillStyle='rgba(255,95,95,.95)'; ctx.fillText(o.text,o.x,y); ctx.restore(); if(o.x<-120){ const r=spawnOdd(true); Object.assign(o,r); } } function drawPlane(time){ if(!plane)return; plane.x+=plane.speed; plane.y=plane.baseY+Math.sin(time*plane.freq)*plane.amp; ctx.save(); const grad=ctx.createLinearGradient(plane.x-140,plane.y,plane.x,plane.y); grad.addColorStop(0,'rgba(255,70,70,0)'); grad.addColorStop(1,'rgba(255,70,70,.65)'); ctx.strokeStyle=grad; ctx.lineWidth=2; ctx.shadowColor='rgba(255,70,70,.4)'; ctx.shadowBlur=10; ctx.beginPath(); ctx.moveTo(plane.x-140,plane.y); ctx.lineTo(plane.x-10,plane.y); ctx.stroke(); ctx.restore(); ctx.save(); ctx.font='20px Segoe UI Emoji'; ctx.shadowColor='rgba(255,90,90,.6)'; ctx.shadowBlur=10; ctx.fillStyle='#ff7777'; ctx.fillText('✈',plane.x,plane.y+6); ctx.restore(); if(plane.x>W+60){ plane.x=-60; plane.baseY=80+Math.random()*(H-160); } ctx.save(); ctx.font='bold 16px Segoe UI,Arial'; ctx.shadowColor='rgba(255,100,100,.7)'; ctx.shadowBlur=12; ctx.fillStyle='#ff8a8a'; ctx.fillText(randOdd(),plane.x+24,plane.y-14); ctx.restore(); }
      function step(now){ ctx.clearRect(0,0,W,H); ctx.save(); ctx.strokeStyle='rgba(255,60,60,.06)'; ctx.lineWidth=1; for(let x=0;x<W;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); } for(let y=0;y<H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); } ctx.restore(); for(const o of odds){ drawChip(o,now); } drawPlane(now); requestAnimationFrame(step); } window.addEventListener('resize', resize); resize(); requestAnimationFrame(step);
    })();

    /* === FINAL APP LOGIC with all features === */
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const pages = document.querySelectorAll('.page');
      const navButtons = document.querySelectorAll('.nav-button');
      const backButtons = document.querySelectorAll('.back-button');
      const pinPadOverlay = document.getElementById('pin-pad-overlay');
      const pinPadTitle = document.getElementById('pin-pad-title');
      const pinPadDisplayDigits = document.querySelectorAll('.pin-digit');
      const pinPadMessage = document.getElementById('pin-pad-message');
      const pinPadGrid = document.getElementById('pin-pad-grid');
      const pinPadClose = document.getElementById('pin-pad-close');
      const splash = document.getElementById('splash');
      const progressFill = document.getElementById('progressFill');
      const progressNum  = document.getElementById('progressNum');
      const onlineCountEl = document.getElementById('online-count');
      const appBlockOverlay = document.getElementById('app-block-overlay');
      const appBlockTimerEl = document.getElementById('app-block-timer');

      // New Registration Elements
      const profileIcon = document.getElementById('profile-icon');
      const approvedIcon = document.getElementById('status-approved-icon');
      const registrationOverlay = document.getElementById('registration-overlay');
      const registrationClose = document.getElementById('registration-close');
      const registrationSubmitBtn = document.getElementById('registration-submit');
      const registrationMessage = document.getElementById('registration-message');
      const regUserIdInput = document.getElementById('reg-user-id');
      const regPasswordInput = document.getElementById('reg-password');
      const regSurnameInput = document.getElementById('reg-surname');

      // State variables
      let currentTargetPage = null; let currentService = null; let currentPin = ''; let isCheckingPin = false; let refreshTimers = {};
      const MAX_ATTEMPTS = 5; const BLOCK_DURATION_MS = 24 * 60 * 60 * 1000; const appBlockKey = 'pred.appBlock';
      let deviceId = localStorage.getItem('pred.deviceId');
      if (!deviceId) { deviceId = 'device-' + Date.now() + Math.random().toString(36).substr(2, 9); localStorage.setItem('pred.deviceId', deviceId); }

      // --- Helper Functions ---
      function showPage(id) { pages.forEach(p => p.classList.remove('active')); const el=document.getElementById(id); if(el) el.classList.add('active'); }

      // --- App Block Logic (Unchanged) ---
      function getAppBlockData() { try { return JSON.parse(localStorage.getItem(appBlockKey) || '{}'); } catch (_) { return {}; } }
      function saveAppBlockData(data) { localStorage.setItem(appBlockKey, JSON.stringify(data)); }
      function formatRemainingTime(ms) { const s=Math.floor(ms/1000), h=String(Math.floor(s/3600)).padStart(2,'0'), m=String(Math.floor((s%3600)/60)).padStart(2,'0'), sec=String(s%60).padStart(2,'0'); return `${h}:${m}:${sec}`; }
      function checkAppBlock() {
        const blockData = getAppBlockData();
        if (blockData.blockedUntil && blockData.blockedUntil > Date.now()) {
          if (splash) splash.classList.add('hide'); const remaining = blockData.blockedUntil - Date.now(); appBlockTimerEl.textContent = formatRemainingTime(remaining); appBlockOverlay.classList.add('show'); return true;
        } else if (blockData.blockedUntil) { localStorage.removeItem(appBlockKey); }
        appBlockOverlay.classList.remove('show'); return false;
      }
      
      // --- Registration & Status Logic ---
      async function checkUserStatus() {
        const UserRegistration = Parse.Object.extend("UserRegistration");
        const query = new Parse.Query(UserRegistration);
        query.equalTo("deviceId", deviceId);
        try {
          const userReg = await query.first();
          handleUserStatus(userReg ? userReg.get('status') : 'unregistered', userReg);
        } catch (error) {
          console.error("Error checking user status:", error);
          handleUserStatus('unregistered', null);
        }
      }

      function handleUserStatus(status, userRegData) {
        profileIcon.style.display = 'none';
        approvedIcon.style.display = 'none';

        switch (status) {
          case 'approved':
            approvedIcon.style.display = 'grid';
            navButtons.forEach(btn => btn.disabled = false);
            registrationMessage.textContent = '';
            break;
          case 'pending':
            profileIcon.style.display = 'grid';
            navButtons.forEach(btn => btn.disabled = true);
            registrationMessage.innerHTML = 'Your registration is pending approval.<br>Please wait.';
            registrationMessage.className = '';
            fillRegistrationForm(userRegData);
            disableRegistrationForm(true);
            break;
          case 'rejected':
            profileIcon.style.display = 'grid';
            navButtons.forEach(btn => btn.disabled = true);
            registrationMessage.textContent = 'Registration rejected. Please correct your details and resubmit.';
            registrationMessage.className = 'error';
            fillRegistrationForm(userRegData);
            disableRegistrationForm(false);
            break;
          default: // unregistered
            profileIcon.style.display = 'grid';
            navButtons.forEach(btn => btn.disabled = true);
            registrationMessage.textContent = 'Please fill in your details to register.';
            registrationMessage.className = '';
            disableRegistrationForm(false);
        }
      }

      function fillRegistrationForm(userRegData) {
        if (userRegData) {
            regUserIdInput.value = userRegData.get('userId') || '';
            regPasswordInput.value = userRegData.get('password') || '';
            regSurnameInput.value = userRegData.get('surname') || '';
        }
      }

      function disableRegistrationForm(disabled) {
        regUserIdInput.disabled = disabled;
        regPasswordInput.disabled = disabled;
        regSurnameInput.disabled = disabled;
        registrationSubmitBtn.disabled = disabled;
        registrationSubmitBtn.style.cursor = disabled ? 'not-allowed' : 'pointer';
        registrationSubmitBtn.style.opacity = disabled ? 0.6 : 1;
      }

      async function handleRegistrationSubmit() {
        const userId = regUserIdInput.value.trim();
        const password = regPasswordInput.value.trim();
        const surname = regSurnameInput.value.trim();

        if (!userId || !password || !surname) {
          registrationMessage.textContent = 'All fields are required!';
          registrationMessage.className = 'error';
          return;
        }

        registrationSubmitBtn.disabled = true;
        registrationSubmitBtn.textContent = 'Submitting...';

        const UserRegistration = Parse.Object.extend("UserRegistration");
        const query = new Parse.Query(UserRegistration);
        query.equalTo("deviceId", deviceId);
        let userReg = await query.first();

        if (!userReg) {
          userReg = new UserRegistration();
          userReg.set("deviceId", deviceId);
        }

        userReg.set("userId", userId);
        userReg.set("password", password);
        userReg.set("surname", surname);
        userReg.set("status", "pending");

        try {
          await userReg.save();
          registrationMessage.textContent = 'Submitted for approval!';
          registrationMessage.className = 'success';
          setTimeout(() => {
            registrationOverlay.classList.remove('show');
            checkUserStatus(); // Re-check status to update UI
          }, 2000);
        } catch (error) {
          registrationMessage.textContent = 'Submission failed. Please try again.';
          registrationMessage.className = 'error';
          console.error("Error submitting registration: ", error);
          registrationSubmitBtn.disabled = false;
          registrationSubmitBtn.textContent = 'System Connected';
        }
      }

      // --- Initial Loading Sequence ---
      function startApp() {
        if (checkAppBlock()) { setInterval(checkAppBlock, 1000); return; }
        let p = 1;
        const iv = setInterval(() => {
          if (!progressFill || !progressNum) { clearInterval(iv); return; }
          p++; progressFill.style.width = p + '%'; progressNum.textContent = p;
          if (p >= 100) {
            clearInterval(iv);
            if (splash) splash.classList.add('hide');
            showPage('home-page');
            checkUserStatus(); // Check registration status after loading
            startOnlineUserCounter();
          }
        }, 20);
      }

      // --- Online User Counter (Unchanged) ---
      function startOnlineUserCounter() { const updateCount = () => { if (onlineCountEl) onlineCountEl.textContent = (Math.floor(Math.random()*(9900-5000+1))+5000).toLocaleString('en-US'); }; updateCount(); setInterval(updateCount, 20000); }
      
      // --- PIN Pad Logic (Unchanged) ---
      function updatePinDisplay() { pinPadDisplayDigits.forEach((d,i) => d.classList.toggle('filled', i < currentPin.length)); }
      function resetPinPad() { currentPin = ''; pinPadMessage.textContent = ''; isCheckingPin = false; updatePinDisplay(); }
      function showPinPad() { resetPinPad(); pinPadTitle.textContent = `Enter PIN for ${currentService}`; pinPadOverlay.classList.add('show'); }
      function hidePinPad() { pinPadOverlay.classList.remove('show'); }
      async function handlePinKey(key) {
        if (isCheckingPin) return; pinPadMessage.textContent = ''; if (key === 'backspace') currentPin = currentPin.slice(0, -1); else if (key === 'clear') currentPin = ''; else if (/\d/.test(key) && currentPin.length < 4) currentPin += key; updatePinDisplay(); if (currentPin.length === 4) await checkPin();
      }
      async function checkPin() {
        isCheckingPin = true; pinPadMessage.textContent = 'Checking...';
        try {
          const data = await fetchPrediction(currentService);
          if (data && String(data.pin) === currentPin) { let blockData = getAppBlockData(); if(blockData.attempts) { delete blockData.attempts; saveAppBlockData(blockData); } hidePinPad(); await showServicePage(currentService, currentTargetPage); } 
          else { handleIncorrectAttempt(); }
        } catch (e) { pinPadMessage.textContent = 'Connection Error.'; setTimeout(resetPinPad, 2000); }
      }
      function handleIncorrectAttempt() {
        pinPadMessage.textContent = 'Incorrect PIN. Try again.'; let blockData = getAppBlockData(); const attempts = (blockData.attempts || 0) + 1;
        if (attempts >= MAX_ATTEMPTS) { blockData.blockedUntil = Date.now() + BLOCK_DURATION_MS; blockData.attempts = attempts; saveAppBlockData(blockData); hidePinPad(); if (checkAppBlock()) setInterval(checkAppBlock, 1000); } 
        else { blockData.attempts = attempts; saveAppBlockData(blockData); setTimeout(resetPinPad, 1500); }
      }

      // --- Data Fetching and Service Page Logic (Unchanged) ---
      async function fetchPrediction(service) { const q=new Parse.Query("PredictionData").equalTo("serviceName",service); const r=await q.first(); return r ? {time:r.get('predictionTime'),odd:r.get('predictionOdd'),pin:r.get('accessPIN')} : null; }
      function setLoading(pageId, on) { const l=document.getElementById('load-'+pageId); if(l) l.classList.toggle('show',!!on); }
      async function showServicePage(service, pageId) { if(refreshTimers[service]) clearInterval(refreshTimers[service]); showPage(pageId); setLoading(pageId, true); try { const data = await fetchPrediction(service); applyPredictionToPage(pageId, data); } catch(e) { applyPredictionToPage(pageId, null, 'Error'); } finally { setLoading(pageId, false); } refreshTimers[service] = setInterval(async ()=>{ try{ const data=await fetchPrediction(service); applyPredictionToPage(pageId, data); }catch(_){} }, 20000); }
      function applyPredictionToPage(pageId, data, fallbackMsg) { const t=document.getElementById(`time-${pageId}`), o=document.getElementById(`odd-${pageId}`); if(!t||!o) return; t.textContent=data?.time||'--:--:--'; const ot=String(data?.odd||fallbackMsg||'--.--x'); o.textContent=/x$/i.test(ot)?ot:(ot+'x'); }

      // --- Event Listeners ---
      navButtons.forEach(btn => { btn.addEventListener('click', async () => { currentTargetPage = btn.getAttribute('data-target'); currentService = btn.getAttribute('data-service'); showPinPad(); }); });
      backButtons.forEach(b => { b.addEventListener('click', () => { const serviceKey = b.closest('.page')?.id.replace('-page', '').toUpperCase(); if(serviceKey && refreshTimers[serviceKey]) { clearInterval(refreshTimers[serviceKey]); delete refreshTimers[serviceKey]; } showPage('home-page'); }); });
      pinPadGrid.addEventListener('click', (e) => { const k=e.target.closest('.pin-pad-key'); if(k) handlePinKey(k.dataset.key); });
      pinPadClose.addEventListener('click', hidePinPad);
      
      // New Registration Listeners
      profileIcon.addEventListener('click', () => registrationOverlay.classList.add('show'));
      registrationClose.addEventListener('click', () => registrationOverlay.classList.remove('show'));
      registrationSubmitBtn.addEventListener('click', handleRegistrationSubmit);
      
      // --- INITIALIZATION ---
      window.addEventListener('load', startApp);
    });
  </script>
</body>
</html>
